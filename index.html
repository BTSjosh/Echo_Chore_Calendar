<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>echo-chore-calendar</title>
    <link rel="manifest" href="/Echo_Chore_Calendar/manifest.json">
    <meta name="theme-color" content="#121212">
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
    <script>
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./sw.js', { scope: './' });
      }
    </script>

    <!-- KEEP-SILK-OPEN: plays a silent MP3 in a loop so Silk treats the page
         as actively playing media and never triggers its ~10-min idle timeout.
         Based on https://gitlab.com/DaGammla/keep-silk-open (MIT) -->
    <script>
      (function () {
        var ua = navigator.userAgent.toLowerCase();
        if (!ua.includes('silk')) return;

        // Resolve silent-loop.mp3 from the same directory as the page.
        // On GitHub Pages this becomes /Echo_Chore_Calendar/silent-loop.mp3
        var mp3 = new URL('silent-loop.mp3', window.location.href).href;

        var audio = document.createElement('audio');
        audio.src = mp3 + '?q=' + Date.now();
        audio.muted = true;
        audio.autoplay = true;
        audio.loop = false;          // we reload manually so Silk sees fresh activity
        document.body.appendChild(audio);

        function reload() {
          audio.src = mp3 + '?q=' + Date.now();
          audio.currentTime = 0;
          audio.play().catch(function () {});
        }

        // When the clip ends, reload it (cache-bust) and play again
        audio.onended = reload;

        // Also reload every 60s as a safety net
        setInterval(reload, 60000);

        // Silk requires a real user gesture before unmuted playback is allowed.
        // Start muted+autoplay, then unmute on first touch.
        var events = ['pointerdown', 'click', 'keydown'];
        function unmute() {
          audio.muted = false;
          reload();
          events.forEach(function (e) { document.removeEventListener(e, unmute); });
        }
        events.forEach(function (e) { document.addEventListener(e, unmute); });
      })();
    </script>

  </body>
</html>